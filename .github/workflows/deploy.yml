name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  scan-and-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run Bearer Security Scan on project
        uses: bearer/bearer-action@v2
        with:
          path: '.'
          format: html
          output: 'public/project-scan-report.html'
          scanner: sast,secrets
          severity: critical,high,medium,low,warning
          exit-code: 0
          
      - name: Create scan info file
        run: |
          cat > public/scan-info.json << EOF
          {
            "repoUrl": "https://github.com/Harmeto/next-bearer-sast-lab",
            "branch": "main",
            "scanDate": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "status": "completed",
            "type": "project"
          }
          EOF
          
      - name: Create static report page
        run: |
          cat > public/report.html << 'EOF'
          <!DOCTYPE html>
          <html lang="es">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Reporte de Seguridad - Bearer CLI Lab</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
                  .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                  .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #e0e0e0; }
                  .loading { text-align: center; padding: 40px; }
                  .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 0 auto 20px; }
                  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>üîç Reporte de Seguridad - Bearer CLI Lab</h1>
                      <p><strong>Repositorio:</strong> https://github.com/Harmeto/next-bearer-sast-lab</p>
                      <p><strong>Rama:</strong> main</p>
                      <p><strong>Fecha:</strong> <span id="scanDate">Cargando...</span></p>
                  </div>
                  <div class="loading">
                      <div class="spinner"></div>
                      <h3>‚è≥ Cargando Reporte de Seguridad</h3>
                      <p>El reporte se est√° cargando autom√°ticamente...</p>
                  </div>
                  <div id="reportContent" style="display: none;"></div>
              </div>
              
              <script>
                  // Cargar el reporte de seguridad
                  fetch('/project-scan-report.html')
                      .then(response => response.text())
                      .then(html => {
                          document.getElementById('reportContent').innerHTML = html;
                          document.getElementById('reportContent').style.display = 'block';
                          document.querySelector('.loading').style.display = 'none';
                      })
                      .catch(error => {
                          console.error('Error loading report:', error);
                          document.querySelector('.loading').innerHTML = '<h3>‚ùå Error al cargar el reporte</h3><p>No se pudo cargar el reporte de seguridad. Por favor, recarga la p√°gina.</p>';
                      });
                  
                  // Actualizar la fecha
                  document.getElementById('scanDate').textContent = new Date().toLocaleString();
              </script>
          </body>
          </html>
          EOF
          
      - name: Commit and push scan results
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Fetch latest changes and pull before committing
          git fetch origin
          git pull origin main || git pull origin main --allow-unrelated-histories || true
          
          # Add and commit the scan results
          git add public/project-scan-report.html public/scan-info.json public/report.html
          git commit -m "Update security scan report $(date -u +%Y-%m-%dT%H:%M:%SZ)" || exit 0
          
          # Push the changes
          git push origin main

  build-and-deploy:
    runs-on: ubuntu-latest
    needs: scan-and-commit
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build
        run: npm run build
        env:
          NODE_ENV: production
          
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./out

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-and-deploy
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
